#!/usr/bin/env python3
import os
import time
import json
import uuid
from pathlib import Path
from fsrs import Card


"""
Input: A deck file similar to tunnel's format
<front of card><tab><back of card>

init_cards will created a Recurs ID for each card, and initialize an FSRS
data JSON entry in $RECURS_HOME/fsrs-scheduling-data
"""


def get_fsrs_data_directory():
    recurs_home = os.getenv("RECURS_HOME")
    if recurs_home:
        return Path(recurs_home) / "fsrs-scheduling-data"

    xdg_data_home = os.getenv("XDG_DATA_HOME", Path.home() / ".local/share")
    return Path(xdg_data_home) / "recurs/fsrs-scheduling-data"


def generate_unique_id():
    return str(int(time.time() * 1000 * 1000 * 10))


def initialize_metadata(deck_file_path):
    fsrs_data_dir = get_fsrs_data_directory()
    fsrs_data_dir.mkdir(parents=True, exist_ok=True)

    initialized_count = 0
    lines = []

    with open(deck_file_path, "r") as deck_file:
        lines = deck_file.readlines()

        for line_number, line in enumerate(lines, start=1):
            # Skip empty lines and comments
            if "\t" not in line:
                continue

            parts = line.strip().split("\t")

            # Only update uninitialized card
            if len(parts) != 2:
                continue

            front, back = parts

            unique_id = generate_unique_id()
            parts.append(unique_id)

            # Create the corresponding JSON metadata file using FSRS Card object
            metadata_path = fsrs_data_dir / f"{unique_id}.json"
            card = Card()
            with open(metadata_path, "w") as metadata_file:
                json.dump(card.to_dict(), metadata_file, indent=4)

            print(f"Line {line_number}: Created card {unique_id}")

            lines[line_number - 1] = "\t".join(parts) + "\n"
            initialized_count += 1

    with open(deck_file_path, "w") as deck_file:
        deck_file.writelines(lines)

    print(f"{deck_file_path}: Created {initialized_count} new cards")


if __name__ == "__main__":
    import sys

    if len(sys.argv) != 2:
        print("Usage: ./init_cards <deck_file_path>")
        sys.exit(1)

    deck_file_path = sys.argv[1]
    initialize_metadata(deck_file_path)
